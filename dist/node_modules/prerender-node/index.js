var http=require("http"),url=require("url"),prerender=module.exports=function(e,t,n){if(!prerender.shouldShowPrerenderedPage(e))return n();prerender.beforeRenderFn(e,function(r,i){if(!r&&i&&typeof i=="string")return t.send(200,i);prerender.getPrerenderedPageResponse(e,function(r){if(r)return prerender.afterRenderFn(e,r),t.set(r.headers),t.send(r.statusCode,r.body);n()})})};prerender.crawlerUserAgents=["baiduspider","facebookexternalhit","twitterbot"],prerender.extensionsToIgnore=[".js",".css",".xml",".less",".png",".jpg",".jpeg",".gif",".pdf",".doc",".txt",".zip",".mp3",".rar",".exe",".wmv",".doc",".avi",".ppt",".mpg",".mpeg",".tif",".wav",".mov",".psd",".ai",".xls",".mp4",".m4a",".swf",".dat",".dmg",".iso",".flv",".m4v",".torrent"],prerender.whitelisted=function(e){return prerender.whitelist=typeof e=="string"?[e]:e,this},prerender.blacklisted=function(e){return prerender.blacklist=typeof e=="string"?[e]:e,this},prerender.shouldShowPrerenderedPage=function(e){var t=e.headers["user-agent"];return t?e.method!="GET"?!1:url.parse(e.url,!0).query.hasOwnProperty("_escaped_fragment_")?!0:prerender.crawlerUserAgents.every(function(e){return t.toLowerCase().indexOf(e.toLowerCase())===-1})?!1:prerender.extensionsToIgnore.some(function(t){return e.url.indexOf(t)!==-1})?!1:Array.isArray(this.whitelist)&&this.whitelist.every(function(t){return(new RegExp(t)).test(e.url)===!1})?!1:Array.isArray(this.blacklist)&&this.blacklist.some(function(t){var n=!1,r=!1,i=new RegExp(t);return n=i.test(e.url)===!0,e.headers.referer&&(r=i.test(e.headers.referer)===!0),n||r})?!1:!0:!1},prerender.getPrerenderedPageResponse=function(e,t){var n=url.parse(prerender.buildApiUrl(e));process.env.PRERENDER_TOKEN&&(n.headers={"X-Prerender-Token":process.env.PRERENDER_TOKEN,"User-Agent":e.headers["user-agent"]}),http.get(n,function(e){var n="";e.on("data",function(e){n+=e}),e.on("end",function(){e.body=n,t(e)})}).on("error",function(e){t(null)})},prerender.buildApiUrl=function(e){var t=prerender.getPrerenderServiceUrl(),n=t.indexOf("/",t.length-1)!==-1?"":"/",r=e.protocol;if(e.get("CF-Visitor")){var i=e.get("CF-Visitor").match(/"scheme":"(http|https)"/);i&&(r=i[1])}var s=r+"://"+e.get("host")+e.url;return t+n+s},prerender.getPrerenderServiceUrl=function(){return this.prerenderServiceUrl||process.env.PRERENDER_SERVICE_URL||"http://prerender.herokuapp.com/"},prerender.beforeRenderFn=function(e,t){return this.beforeRender?this.beforeRender(e,t):t()},prerender.afterRenderFn=function(e,t){if(!this.afterRender)return;this.afterRender(e,t)},prerender.set=function(e,t){return this[e]=t,this};